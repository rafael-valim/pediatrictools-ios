default_platform(:ios)

platform :ios do

  desc "Generate App Store screenshots on iPhone and iPad"
  lane :screenshots do
    # Run the screenshot script for each device
    sh("../scripts/take-appstore-screenshots.sh")
  end

  desc "Build the app for App Store distribution"
  lane :build do
    api_key = app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_API_KEY_KEY_ID"],
      issuer_id: ENV["APP_STORE_CONNECT_API_KEY_ISSUER_ID"],
      key_content: ENV["APP_STORE_CONNECT_API_KEY_KEY"],
      is_key_content_base64: false
    )

    build_app(
      scheme: "PediatricTools",
      project: "PediatricTools.xcodeproj",
      export_method: "app-store",
      output_directory: "./build",
      output_name: "PediatricTools.ipa",
      clean: true,
      include_bitcode: false,
      export_options: {
        signingStyle: "automatic",
        teamID: "CJXZNY36RV"
      },
      xcargs: "-allowProvisioningUpdates"
    )
  end

  desc "Create In-App Purchase products in App Store Connect"
  lane :setup_iap do
    require "json"
    require "net/http"
    require "uri"

    api_key = app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_API_KEY_KEY_ID"],
      issuer_id: ENV["APP_STORE_CONNECT_API_KEY_ISSUER_ID"],
      key_content: ENV["APP_STORE_CONNECT_API_KEY_KEY"],
      is_key_content_base64: false
    )

    # Read IAP product definitions
    products = JSON.parse(File.read("../fastlane/iap_products.json"))

    # Get the app ID from App Store Connect
    app = Spaceship::ConnectAPI::App.find("com.RV.pediatrictools.app")
    UI.user_error!("App not found in App Store Connect. Register it first.") unless app

    products.each do |product|
      UI.message("Creating IAP: #{product['productId']}...")

      begin
        # Create the In-App Purchase
        iap = Spaceship::ConnectAPI.post_in_app_purchase(
          app_id: app.id,
          name: product["referenceName"],
          product_id: product["productId"],
          in_app_purchase_type: product["type"] == "NON_CONSUMABLE" ? "NON_CONSUMABLE" : product["type"]
        )

        iap_id = iap.id
        UI.success("Created IAP: #{product['productId']} (#{iap_id})")

        # Add localizations
        product["localizations"].each do |locale, strings|
          UI.message("  Adding localization: #{locale}")
          Spaceship::ConnectAPI.post_in_app_purchase_localization(
            in_app_purchase_id: iap_id,
            locale: locale,
            name: strings["name"],
            description: strings["description"]
          )
        end

        # Set price
        UI.message("  Setting price: $#{product['price']}")
        Spaceship::ConnectAPI.post_in_app_purchase_price_schedule(
          in_app_purchase_id: iap_id,
          base_territory: "USA",
          price: product["price"]
        )

        # Submit for review
        UI.message("  Submitting for review...")
        Spaceship::ConnectAPI.post_in_app_purchase_submission(
          in_app_purchase_id: iap_id
        )

        UI.success("  IAP #{product['productId']} configured and submitted!")
      rescue => e
        UI.important("  Skipping #{product['productId']}: #{e.message}")
      end
    end

    UI.success("IAP setup complete!")
  end

  desc "Full release pipeline: screenshots, build, upload, and submit"
  lane :release do
    screenshots
    build
    upload_to_app_store(
      skip_metadata: false,
      skip_screenshots: false,
      force: true,
      submit_for_review: true,
      automatic_release: false,
      submission_information: {
        add_id_info_uses_idfa: false
      },
      precheck_include_in_app_purchases: false
    )
  end

end
