default_platform(:ios)

# Read a credential from macOS Keychain, falling back to an environment variable.
# Note: macOS `security -w` returns hex-encoded output for passwords containing
# newlines (like P8 keys). We detect and decode hex automatically.
def keychain_or_env(account, env_var)
  value = `security find-generic-password -s "pediatrictools-fastlane" -a "#{account}" -w 2>/dev/null`.strip
  if value.empty?
    ENV[env_var]
  elsif value.match?(/\A[0-9a-fA-F]+\z/) && value.length > 40
    [value].pack("H*")
  else
    value
  end
end

# Build an App Store Connect API key from Keychain (preferred) or environment variables.
def load_api_key
  app_store_connect_api_key(
    key_id: keychain_or_env("key_id", "APP_STORE_CONNECT_API_KEY_KEY_ID"),
    issuer_id: keychain_or_env("issuer_id", "APP_STORE_CONNECT_API_KEY_ISSUER_ID"),
    key_content: keychain_or_env("key_content", "APP_STORE_CONNECT_API_KEY_KEY"),
    is_key_content_base64: false
  )
end

platform :ios do

  desc "Generate App Store screenshots on iPhone and iPad"
  lane :screenshots do
    sh("../scripts/take-appstore-screenshots.sh")
  end

  desc "Build the app for App Store distribution"
  lane :build do
    api_key = load_api_key

    build_app(
      scheme: "PediatricTools",
      project: "PediatricTools.xcodeproj",
      export_method: "app-store",
      output_directory: "./build",
      output_name: "PediatricTools.ipa",
      clean: true,
      include_bitcode: false,
      export_options: {
        signingStyle: "automatic",
        teamID: "CJXZNY36RV"
      },
      xcargs: "-allowProvisioningUpdates"
    )
  end

  desc "Upload metadata to App Store Connect"
  lane :upload_metadata do
    api_key = load_api_key

    deliver(
      api_key: api_key,
      skip_binary_upload: true,
      skip_screenshots: true,
      skip_metadata: false,
      force: true,
      precheck_include_in_app_purchases: false
    )
  end

  desc "Upload screenshots to App Store Connect"
  lane :upload_screenshots do
    api_key = load_api_key

    deliver(
      api_key: api_key,
      skip_binary_upload: true,
      skip_screenshots: false,
      skip_metadata: true,
      overwrite_screenshots: true,
      force: true,
      precheck_include_in_app_purchases: false
    )
  end

  desc "Upload an existing .ipa to TestFlight"
  lane :upload_binary do
    api_key = load_api_key

    upload_to_testflight(
      api_key: api_key,
      ipa: "./build/PediatricTools.ipa",
      skip_waiting_for_build_processing: true
    )
  end

  desc "Build and upload to TestFlight"
  lane :build_and_upload do
    build
    upload_binary
  end

  desc "Submit the current version for App Store review"
  lane :submit_for_review do
    deliver(
      api_key: load_api_key,
      skip_binary_upload: true,
      skip_metadata: true,
      skip_screenshots: true,
      force: true,
      submit_for_review: true,
      automatic_release: false,
      submission_information: {
        add_id_info_uses_idfa: false
      },
      precheck_include_in_app_purchases: false
    )
  end

  desc "Full release: build, upload to TestFlight, then deliver metadata + screenshots"
  lane :release do
    build
    upload_binary
    deliver(
      api_key: load_api_key,
      skip_binary_upload: true,
      skip_metadata: false,
      skip_screenshots: false,
      force: true,
      submit_for_review: true,
      automatic_release: false,
      submission_information: {
        add_id_info_uses_idfa: false
      },
      precheck_include_in_app_purchases: false
    )
  end

end
